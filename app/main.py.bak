from bson import json_util
from fastapi.responses import JSONResponse
from fastapi import FastAPI
from slowapi.middleware import SlowAPIMiddleware
from slowapi.errors import RateLimitExceeded
from slowapi import _rate_limit_exceeded_handler
from app.middleware.ratelimit import limiter, Request
from app.middleware.tenancy_middleware import TenancyMiddleware
from app.middleware.ratelimit import init_rate_limit, limiter
from app.api import auth_routes, protected_routes, admin, kavach, rudra, trinetra, nandi

class MongoJSONResponse(JSONResponse):
    def render(self, content) -> bytes:
        return json_util.dumps(content).encode('utf-8')
app = FastAPI(default_response_class=MongoJSONResponse, title="Trishul Core")


app.state.limiter = limiter
app.add_middleware(SlowAPIMiddleware)
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)
# middleware
app.add_middleware(TenancyMiddleware)
init_rate_limit(app)

# Public
@app.get("/health")
async def health():
    return {"ok": True}

# Dummy endpoint with 5/min limit
@app.get("/dummy")
@limiter.limit("5/minute")
async def dummy(request: Request):
    return {"ok": True, "msg": "dummy endpoint success"}

# Routers
app.include_router(auth_routes.router)       # /auth/*
app.include_router(protected_routes.router)  # /admin/health etc.
app.include_router(admin.router)             # /admin/stats
app.include_router(kavach.router)            # /kavach/*
app.include_router(rudra.router)             # /rudra/*
app.include_router(trinetra.router)          # /trinetra/*
app.include_router(nandi.router)             # /nandi/*



